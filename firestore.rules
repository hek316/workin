rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users collection rules
    match /users/{userId} {
      // Users can read their own document
      // Admins can read all user documents
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own document during signup
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['uid', 'email', 'name', 'role', 'createdAt']) &&
                       request.resource.data.uid == userId &&
                       request.resource.data.role == 'employee'; // New users are employees by default

      // Users can update their own document (except role and uid)
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'role']);

      // Only admins can delete user documents
      allow delete: if isAdmin();
    }

    // Attendance collection rules (준비용 - SCRUM-7에서 사용)
    match /attendance/{attendanceId} {
      // Users can read their own attendance records
      // Admins can read all attendance records
      allow read: if isAuthenticated() &&
                     (resource.data.uid == request.auth.uid || isAdmin());

      // Users can create their own attendance records
      allow create: if isAuthenticated() &&
                       request.resource.data.uid == request.auth.uid;

      // Users can update their own attendance records
      // Admins can update all attendance records
      allow update: if isAuthenticated() &&
                       (resource.data.uid == request.auth.uid || isAdmin());

      // Only admins can delete attendance records
      allow delete: if isAdmin();
    }

    // Approvals collection rules (준비용 - SCRUM-7에서 사용)
    match /approvals/{approvalId} {
      // Users can read their own approval requests
      // Admins can read all approval requests
      allow read: if isAuthenticated() &&
                     (resource.data.uid == request.auth.uid || isAdmin());

      // Users can create their own approval requests
      allow create: if isAuthenticated() &&
                       request.resource.data.uid == request.auth.uid &&
                       request.resource.data.status == 'pending';

      // Users can update their own pending approval requests
      // Admins can update any approval requests (for approval/rejection)
      allow update: if (isAuthenticated() &&
                        resource.data.uid == request.auth.uid &&
                        resource.data.status == 'pending') ||
                       isAdmin();

      // Only admins can delete approval requests
      allow delete: if isAdmin();
    }

    // Settings collection rules
    match /settings/{settingId} {
      // Everyone can read settings
      allow read: if isAuthenticated();

      // Only admins can modify settings
      allow write: if isAdmin();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
